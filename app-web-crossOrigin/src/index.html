<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Authentication Demo</title>
</head>

<body>
    <h1>Welcome to the Demo Page</h1>
    <p id="message">Checking authentication...</p>

    <script>
        // 伪造一个简单的 Token 验证函数（实际应用应调用后端接口验证 Token）
        async function validateToken(token) {
            try {
                // 请求验证 Token 的合法性
                const response = await fetch('http://' + window.location.host + "/omirequest" + "/用户登录注册服务" + "/tokenValidation", {
                    method: "GET",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                return response.ok;
            } catch (error) {
                console.error("Token validation failed:", error);
                return false;
            }
        }

        // 获取 URL 参数中的 Token
        function getTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("token");
        }

        // 主函数：检查 Token 并跳转或继续
        async function checkAuthentication() {
            const urlToken = getTokenFromUrl();
            let token = urlToken || localStorage.getItem("token");

            // 如果从 URL 获得了 Token，则尝试验证并存储到 localStorage
            if (urlToken) {
                if (await validateToken(urlToken)) {
                    localStorage.setItem("token", urlToken);
                    document.getElementById("message").textContent = "Authenticated with URL token!";
                } else {
                    // URL Token 不合法，跳转到登录页面
                    redirectToLogin();
                }
            } else if (token) {
                // 如果 URL 中没有 Token，但 localStorage 中有 Token，则验证
                if (await validateToken(token)) {
                    document.getElementById("message").textContent = "Authenticated with stored token!";
                } else {
                    // localStorage 中的 Token 不合法，清除并跳转到登录页面
                    localStorage.removeItem("token");
                    redirectToLogin();
                }
            } else {
                // 如果 URL 和 localStorage 都没有 Token，跳转到登录页面
                redirectToLogin();
            }
        }

        // 跳转到登录页面函数
        function redirectToLogin() {
            alert("Invalid or expired token. Redirecting to login page...");
            window.location.href = "http://118.25.196.166:8081?url=" + window.location.host; // 这里设定登录页面的路径
        }
        // 执行主函数
        checkAuthentication();
    </script>
</body>

</html>